---
redirect_from:
  - "/03/julia-test"
interact_link: content/03/Julia_test.ipynb
kernel_name: julia-1.3
kernel_path: content/03
has_widgets: false
title: |-
  Code Example
pagenum: 3
prev_page:
  url: /02/theory.html
next_page:
  url: /04/00.html
suffix: .ipynb
search: chen nk wu ph main program starts here need modify code below although different value patchsize

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Code Example</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr>
<p><em>Chen NK</em> | <em>Wu PH</em></p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="c"># julia 1.0.1</span>

<span class="c">###### define the parameters in the next 7 lines</span>
<span class="n">magnitude_nii_file</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;data/magnitude.nii&quot;</span><span class="p">);</span>
<span class="n">phase_nii_file</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;data/phase.nii&quot;</span><span class="p">);</span>
<span class="n">partiallyUnwrapped_nii_file</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;data/partiallyUnwrappedMap.nii&quot;</span><span class="p">);</span>
<span class="n">criticalROI_nii_file</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;data/criticalROI.nii&quot;</span><span class="p">);</span>
<span class="n">ChooseThisSlice</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="c"># process data in a chosen slice; e.g., slice #5 in this case</span>
<span class="n">criticalROILabel</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c"># unwrap phase values inside a critical ROI labeled with an integer number; e.g., 1 in this case</span>
<span class="n">output_nii_file</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;data/output.nii&quot;</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The main program starts here; no need to modify the code below (although you could use different value of patchsize)</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="n">push!</span><span class="p">(</span><span class="nb">LOAD_PATH</span><span class="p">,</span><span class="s">&quot;juliafunction&quot;</span><span class="p">);</span>
<span class="k">using</span> <span class="n">PyPlot</span>
<span class="k">using</span> <span class="n">Read_NIfTI1</span>
<span class="k">using</span> <span class="n">myFun</span>
<span class="k">using</span> <span class="n">Distributed</span>
<span class="c"># addprocs(Sys.CPU_THREADS-nprocs());</span>
<span class="c"># nprocs()</span>
<span class="nd">@everywhere</span> <span class="k">using</span> <span class="n">FFTW</span>
<span class="nd">@everywhere</span> <span class="k">using</span> <span class="n">LinearAlgebra</span>
<span class="nd">@everywhere</span> <span class="k">using</span> <span class="n">SharedArrays</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="k">function</span> <span class="n">julia_main</span><span class="p">(</span><span class="n">magnitude_nii_file</span><span class="o">::</span><span class="n">String</span><span class="p">,</span><span class="n">phase_nii_file</span><span class="o">::</span><span class="n">String</span><span class="p">,</span><span class="n">partiallyUnwrapped_nii_file</span><span class="o">::</span><span class="n">String</span><span class="p">,</span><span class="n">criticalROI_nii_file</span><span class="o">::</span><span class="n">String</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="o">::</span><span class="kt">Int64</span><span class="p">,</span><span class="n">criticalROILabel</span><span class="o">::</span><span class="kt">Int64</span><span class="p">)</span>
    <span class="n">headerinfo1</span> <span class="o">=</span> <span class="n">load_nii_header</span><span class="p">(</span><span class="n">magnitude_nii_file</span><span class="p">);</span>
    <span class="n">data001</span> <span class="o">=</span> <span class="n">load_nii_data</span><span class="p">(</span><span class="n">magnitude_nii_file</span><span class="p">,</span> <span class="n">headerinfo1</span><span class="p">);</span>
    <span class="n">headerinfo1</span> <span class="o">=</span> <span class="n">load_nii_header</span><span class="p">(</span><span class="n">phase_nii_file</span><span class="p">);</span>
    <span class="n">data002</span> <span class="o">=</span> <span class="n">load_nii_data</span><span class="p">(</span><span class="n">phase_nii_file</span><span class="p">,</span> <span class="n">headerinfo1</span><span class="p">);</span>
    <span class="n">imagedata_noise</span> <span class="o">=</span> <span class="n">data001</span> <span class="o">.*</span> <span class="n">exp</span><span class="o">.</span><span class="p">(</span><span class="n">complex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">data002</span><span class="p">);</span>

    <span class="n">imgsn</span> <span class="o">=</span> <span class="n">imagedata_noise</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">];</span>
    <span class="n">ksn</span> <span class="o">=</span> <span class="n">ifftshift</span><span class="p">(</span><span class="n">ifft</span><span class="p">(</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">imgsn</span><span class="p">)));</span>

    <span class="nd">@everywhere</span> <span class="k">function</span> <span class="n">sidm</span><span class="p">(</span><span class="n">kdata</span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Complex</span><span class="p">{</span><span class="kt">Float32</span><span class="p">},</span><span class="mi">2</span><span class="p">})</span>
        <span class="n">kabs</span> <span class="o">=</span> <span class="n">abs</span><span class="o">.</span><span class="p">(</span><span class="n">kdata</span><span class="p">);</span>
        <span class="n">pxpy</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">kabs</span> <span class="o">.==</span> <span class="n">maximum</span><span class="p">(</span><span class="n">kabs</span><span class="p">));</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">pxpy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">pxpy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">);</span>
    <span class="k">end</span>

    <span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">imgsn</span><span class="p">)</span>

    <span class="n">pxmap</span> <span class="o">=</span> <span class="kt">SharedArray</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">2</span><span class="p">}((</span><span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">));</span>
    <span class="n">pymap</span> <span class="o">=</span> <span class="kt">SharedArray</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">2</span><span class="p">}((</span><span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">));</span>

    <span class="n">patchsize</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="n">patchsize</span> <span class="o">=</span> <span class="n">patchsize</span> <span class="o">+</span> <span class="n">div</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.^</span><span class="n">patchsize</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ps1</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">div</span><span class="p">((</span><span class="n">patchsize</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>

    <span class="nd">@time</span> <span class="nd">@sync</span> <span class="nd">@distributed</span> <span class="k">for</span> <span class="n">cntx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">datasize1</span>
        <span class="nd">@inbounds</span> <span class="nd">@fastmath</span> <span class="nd">@simd</span> <span class="k">for</span> <span class="n">cnty</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">datasize2</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">ComplexF32</span><span class="p">,(</span><span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">));</span>
            <span class="n">startingx</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cntx</span><span class="o">-</span><span class="n">ps1</span><span class="p">);</span>
            <span class="n">startingy</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cnty</span><span class="o">-</span><span class="n">ps1</span><span class="p">);</span>
            <span class="n">endingx</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cntx</span><span class="o">+</span><span class="n">ps1</span><span class="p">,</span><span class="n">datasize1</span><span class="p">);</span>
            <span class="n">endingy</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cnty</span><span class="o">+</span><span class="n">ps1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">);</span>
            <span class="n">tmp1</span><span class="p">[</span><span class="n">startingx</span><span class="o">:</span><span class="n">endingx</span><span class="p">,</span><span class="n">startingy</span><span class="o">:</span><span class="n">endingy</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgsn</span><span class="p">[</span><span class="n">startingx</span><span class="o">:</span><span class="n">endingx</span><span class="p">,</span><span class="n">startingy</span><span class="o">:</span><span class="n">endingy</span><span class="p">];</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">ifftshift</span><span class="p">(</span><span class="n">ifft</span><span class="p">(</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">tmp1</span><span class="p">)));</span>
            <span class="n">px</span><span class="p">,</span><span class="n">py</span> <span class="o">=</span> <span class="n">sidm</span><span class="p">(</span><span class="n">tmp2</span><span class="p">);</span>
            <span class="n">pxmap</span><span class="p">[</span><span class="n">cntx</span><span class="p">,</span><span class="n">cnty</span><span class="p">]</span><span class="o">=</span><span class="n">px</span><span class="p">;</span>
            <span class="n">pymap</span><span class="p">[</span><span class="n">cntx</span><span class="p">,</span><span class="n">cnty</span><span class="p">]</span><span class="o">=</span><span class="n">py</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">pxmap2a</span> <span class="o">=</span> <span class="n">pxmap</span><span class="o">.-</span><span class="p">(</span><span class="n">datasize1</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">pymap2a</span> <span class="o">=</span> <span class="n">pymap</span><span class="o">.-</span><span class="p">(</span><span class="n">datasize2</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">pxmap_radppixel</span> <span class="o">=</span> <span class="o">-</span><span class="n">pxmap2a</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="nb">π</span><span class="o">/</span><span class="n">datasize1</span><span class="p">;</span>
    <span class="n">pymap_radppixel</span> <span class="o">=</span> <span class="o">-</span><span class="n">pymap2a</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="nb">π</span><span class="o">/</span><span class="n">datasize2</span><span class="p">;</span>

    <span class="n">headerinfo4</span> <span class="o">=</span> <span class="n">load_nii_header</span><span class="p">(</span><span class="n">partiallyUnwrapped_nii_file</span><span class="p">);</span>
    <span class="n">preludephasemap_all</span> <span class="o">=</span> <span class="n">load_nii_data</span><span class="p">(</span><span class="n">partiallyUnwrapped_nii_file</span><span class="p">,</span> <span class="n">headerinfo4</span><span class="p">);</span>
    <span class="n">preludephasemap</span> <span class="o">=</span> <span class="n">preludephasemap_all</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">];</span>

    <span class="n">preludemask</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">);</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">preludephasemap</span><span class="o">.==</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">preludemask</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">preludephasemap_cpe</span> <span class="o">=</span> <span class="n">closest_point_estimation</span><span class="p">(</span><span class="n">preludephasemap</span><span class="p">,</span><span class="n">preludemask</span><span class="p">);</span>

    <span class="n">headerinfo5</span> <span class="o">=</span> <span class="n">load_nii_header</span><span class="p">(</span><span class="n">criticalROI_nii_file</span><span class="p">);</span>
    <span class="n">criticalROI_all</span> <span class="o">=</span> <span class="n">load_nii_data</span><span class="p">(</span><span class="n">criticalROI_nii_file</span><span class="p">,</span> <span class="n">headerinfo5</span><span class="p">);</span>
    <span class="n">criticalROI</span> <span class="o">=</span> <span class="n">criticalROI_all</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">];</span>

    <span class="n">L2</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">criticalROI</span><span class="o">.==</span><span class="n">criticalROILabel</span><span class="p">);</span>

    <span class="k">if</span> <span class="n">length</span><span class="p">(</span><span class="n">L2</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
        <span class="n">xcoordarray</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="kt">Int64</span><span class="p">,</span><span class="n">length</span><span class="p">(</span><span class="n">L2</span><span class="p">));</span>
        <span class="n">ycoordarray</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="kt">Int64</span><span class="p">,</span><span class="n">length</span><span class="p">(</span><span class="n">L2</span><span class="p">));</span>
        <span class="k">for</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">L2</span><span class="p">)</span>
            <span class="n">xcoordarray</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="n">cnt</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">ycoordarray</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="n">cnt</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
        <span class="k">end</span>

        <span class="n">roiStartX</span> <span class="o">=</span> <span class="n">minimum</span><span class="p">(</span><span class="n">xcoordarray</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">roiEndX</span> <span class="o">=</span> <span class="n">maximum</span><span class="p">(</span><span class="n">xcoordarray</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">roiStartY</span> <span class="o">=</span> <span class="n">minimum</span><span class="p">(</span><span class="n">ycoordarray</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">roiEndY</span> <span class="o">=</span> <span class="n">maximum</span><span class="p">(</span><span class="n">ycoordarray</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">xdim</span> <span class="o">=</span> <span class="n">roiEndX</span><span class="o">-</span><span class="n">roiStartX</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">ydim</span> <span class="o">=</span> <span class="n">roiEndY</span><span class="o">-</span><span class="n">roiStartY</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

        <span class="n">boundaryConditionMap</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span><span class="n">preludephasemap_cpe</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">]);</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">xdim</span><span class="p">,</span><span class="n">ydim</span><span class="p">)</span><span class="o">-</span><span class="n">criticalROI</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">];</span>
        <span class="n">snr_ref</span> <span class="o">=</span> <span class="n">abs</span><span class="o">.</span><span class="p">(</span><span class="n">imgsn</span><span class="p">)[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">]</span><span class="o">.*</span><span class="n">mask</span><span class="p">;</span>
        <span class="n">λmap</span> <span class="o">=</span> <span class="n">snr_ref</span> <span class="o">./</span><span class="n">maximum</span><span class="p">(</span><span class="n">snr_ref</span><span class="p">[</span><span class="o">:</span><span class="p">]);</span>
        <span class="n">λmap</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.=</span><span class="mf">2.</span><span class="p">;</span>
        <span class="n">λmap</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="k">end</span><span class="p">]</span><span class="o">.=</span><span class="mf">2.</span><span class="p">;</span>
        <span class="n">λmap</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="o">.=</span><span class="mf">2.</span><span class="p">;</span>
        <span class="n">λmap</span><span class="p">[</span><span class="k">end</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="o">.=</span><span class="mf">2.</span><span class="p">;</span>
        <span class="n">Mgv</span> <span class="o">=</span> <span class="n">pxmap_radppixel</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">];</span>
        <span class="n">Mgh</span> <span class="o">=</span> <span class="n">pymap_radppixel</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">];</span>

        <span class="n">M_recovered</span> <span class="o">=</span> <span class="n">twoDimIntegration</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">boundaryConditionMap</span><span class="p">,</span><span class="n">λmap</span><span class="p">,</span><span class="n">Mgv</span><span class="p">,</span><span class="n">Mgh</span><span class="p">);</span>

        <span class="n">newPhaseMap</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">preludephasemap_cpe</span><span class="p">);</span>
        <span class="n">newPhaseMap</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">]</span><span class="o">=</span> <span class="n">M_recovered</span><span class="p">;</span>
        <span class="n">newPhaseMapMask</span> <span class="o">=</span> <span class="n">newPhaseMap</span><span class="o">.*</span><span class="n">preludemask</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">newPhaseMap</span> <span class="o">=</span> <span class="n">preludephasemap</span><span class="p">;</span>
        <span class="n">newPhaseMapMask</span> <span class="o">=</span> <span class="n">newPhaseMap</span><span class="o">.*</span><span class="n">preludemask</span><span class="p">;</span>
    <span class="k">end</span>

    <span class="n">headerinfo4</span><span class="p">[</span><span class="s">&quot;datatype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kt">Int16</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
    <span class="n">output_all</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span> <span class="n">preludephasemap_all</span><span class="p">);</span>
    <span class="n">newPhaseMapMask</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span> <span class="n">newPhaseMapMask</span><span class="p">);</span>
    <span class="n">output_all</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">]</span> <span class="o">=</span> <span class="n">newPhaseMapMask</span><span class="p">;</span>
    <span class="n">write_nii_header</span><span class="p">(</span><span class="n">output_nii_file</span><span class="p">,</span> <span class="n">headerinfo4</span><span class="p">);</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">output_nii_file</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">output_all</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>

    <span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span><span class="n">imshow</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">permutedims</span><span class="p">(</span><span class="n">vcat</span><span class="p">(</span><span class="n">preludephasemap</span><span class="p">,</span><span class="n">newPhaseMapMask</span><span class="p">),[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="n">dims</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="s">&quot;hot&quot;</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">);</span> <span class="n">axis</span><span class="p">(</span><span class="s">&quot;off&quot;</span><span class="p">);</span>
<span class="c">#     figure(2,figsize=(10,5));imshow(reverse(permutedims(vcat(preludephasemap_cpe,newPhaseMap),[2,1]),dims=1),cmap=&quot;hot&quot;,interpolation=&quot;none&quot;); axis(&quot;off&quot;);</span>

<span class="k">end</span>

<span class="n">julia_main</span><span class="p">(</span><span class="n">magnitude_nii_file</span><span class="p">,</span><span class="n">phase_nii_file</span><span class="p">,</span><span class="n">partiallyUnwrapped_nii_file</span><span class="p">,</span><span class="n">criticalROI_nii_file</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">,</span><span class="n">criticalROILabel</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> </pre>
</div>
</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../images/03/Julia_test_4_1.png"
>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>11.629099 seconds (2.42 M allocations: 3.519 GiB, 9.63% gc time)
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-julia"><pre><span></span><span class="k">function</span> <span class="n">julia_main</span><span class="p">(</span><span class="n">magnitude_nii_file</span><span class="o">::</span><span class="n">String</span><span class="p">,</span><span class="n">phase_nii_file</span><span class="o">::</span><span class="n">String</span><span class="p">,</span><span class="n">partiallyUnwrapped_nii_file</span><span class="o">::</span><span class="n">String</span><span class="p">,</span><span class="n">criticalROI_nii_file</span><span class="o">::</span><span class="n">String</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="o">::</span><span class="kt">Int64</span><span class="p">,</span><span class="n">criticalROILabel</span><span class="o">::</span><span class="kt">Int64</span><span class="p">)</span>
    <span class="n">headerinfo1</span> <span class="o">=</span> <span class="n">load_nii_header</span><span class="p">(</span><span class="n">magnitude_nii_file</span><span class="p">);</span>
    <span class="n">data001</span> <span class="o">=</span> <span class="n">load_nii_data</span><span class="p">(</span><span class="n">magnitude_nii_file</span><span class="p">,</span> <span class="n">headerinfo1</span><span class="p">);</span>
    <span class="n">headerinfo1</span> <span class="o">=</span> <span class="n">load_nii_header</span><span class="p">(</span><span class="n">phase_nii_file</span><span class="p">);</span>
    <span class="n">data002</span> <span class="o">=</span> <span class="n">load_nii_data</span><span class="p">(</span><span class="n">phase_nii_file</span><span class="p">,</span> <span class="n">headerinfo1</span><span class="p">);</span>
    <span class="n">imagedata_noise</span> <span class="o">=</span> <span class="n">data001</span> <span class="o">.*</span> <span class="n">exp</span><span class="o">.</span><span class="p">(</span><span class="n">complex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">data002</span><span class="p">);</span>

    <span class="n">imgsn</span> <span class="o">=</span> <span class="n">imagedata_noise</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">];</span>
    <span class="n">ksn</span> <span class="o">=</span> <span class="n">ifftshift</span><span class="p">(</span><span class="n">ifft</span><span class="p">(</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">imgsn</span><span class="p">)));</span>

    <span class="nd">@everywhere</span> <span class="k">function</span> <span class="n">sidm</span><span class="p">(</span><span class="n">kdata</span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Complex</span><span class="p">{</span><span class="kt">Float32</span><span class="p">},</span><span class="mi">2</span><span class="p">})</span>
        <span class="n">kabs</span> <span class="o">=</span> <span class="n">abs</span><span class="o">.</span><span class="p">(</span><span class="n">kdata</span><span class="p">);</span>
        <span class="n">pxpy</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">kabs</span> <span class="o">.==</span> <span class="n">maximum</span><span class="p">(</span><span class="n">kabs</span><span class="p">));</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">pxpy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">pxpy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">);</span>
    <span class="k">end</span>

    <span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">imgsn</span><span class="p">)</span>

    <span class="n">pxmap</span> <span class="o">=</span> <span class="kt">SharedArray</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">2</span><span class="p">}((</span><span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">));</span>
    <span class="n">pymap</span> <span class="o">=</span> <span class="kt">SharedArray</span><span class="p">{</span><span class="kt">Float64</span><span class="p">,</span><span class="mi">2</span><span class="p">}((</span><span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">));</span>

    <span class="n">patchsize</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
    <span class="n">patchsize</span> <span class="o">=</span> <span class="n">patchsize</span> <span class="o">+</span> <span class="n">div</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.^</span><span class="n">patchsize</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ps1</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">div</span><span class="p">((</span><span class="n">patchsize</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>

    <span class="nd">@time</span> <span class="nd">@sync</span> <span class="nd">@distributed</span> <span class="k">for</span> <span class="n">cntx</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">datasize1</span>
        <span class="nd">@inbounds</span> <span class="nd">@fastmath</span> <span class="nd">@simd</span> <span class="k">for</span> <span class="n">cnty</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">datasize2</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">ComplexF32</span><span class="p">,(</span><span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">));</span>
            <span class="n">startingx</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cntx</span><span class="o">-</span><span class="n">ps1</span><span class="p">);</span>
            <span class="n">startingy</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cnty</span><span class="o">-</span><span class="n">ps1</span><span class="p">);</span>
            <span class="n">endingx</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cntx</span><span class="o">+</span><span class="n">ps1</span><span class="p">,</span><span class="n">datasize1</span><span class="p">);</span>
            <span class="n">endingy</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cnty</span><span class="o">+</span><span class="n">ps1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">);</span>
            <span class="n">tmp1</span><span class="p">[</span><span class="n">startingx</span><span class="o">:</span><span class="n">endingx</span><span class="p">,</span><span class="n">startingy</span><span class="o">:</span><span class="n">endingy</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgsn</span><span class="p">[</span><span class="n">startingx</span><span class="o">:</span><span class="n">endingx</span><span class="p">,</span><span class="n">startingy</span><span class="o">:</span><span class="n">endingy</span><span class="p">];</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">ifftshift</span><span class="p">(</span><span class="n">ifft</span><span class="p">(</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">tmp1</span><span class="p">)));</span>
            <span class="n">px</span><span class="p">,</span><span class="n">py</span> <span class="o">=</span> <span class="n">sidm</span><span class="p">(</span><span class="n">tmp2</span><span class="p">);</span>
            <span class="n">pxmap</span><span class="p">[</span><span class="n">cntx</span><span class="p">,</span><span class="n">cnty</span><span class="p">]</span><span class="o">=</span><span class="n">px</span><span class="p">;</span>
            <span class="n">pymap</span><span class="p">[</span><span class="n">cntx</span><span class="p">,</span><span class="n">cnty</span><span class="p">]</span><span class="o">=</span><span class="n">py</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">pxmap2a</span> <span class="o">=</span> <span class="n">pxmap</span><span class="o">.-</span><span class="p">(</span><span class="n">datasize1</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">pymap2a</span> <span class="o">=</span> <span class="n">pymap</span><span class="o">.-</span><span class="p">(</span><span class="n">datasize2</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">pxmap_radppixel</span> <span class="o">=</span> <span class="o">-</span><span class="n">pxmap2a</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="nb">π</span><span class="o">/</span><span class="n">datasize1</span><span class="p">;</span>
    <span class="n">pymap_radppixel</span> <span class="o">=</span> <span class="o">-</span><span class="n">pymap2a</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="nb">π</span><span class="o">/</span><span class="n">datasize2</span><span class="p">;</span>

    <span class="n">headerinfo4</span> <span class="o">=</span> <span class="n">load_nii_header</span><span class="p">(</span><span class="n">partiallyUnwrapped_nii_file</span><span class="p">);</span>
    <span class="n">preludephasemap_all</span> <span class="o">=</span> <span class="n">load_nii_data</span><span class="p">(</span><span class="n">partiallyUnwrapped_nii_file</span><span class="p">,</span> <span class="n">headerinfo4</span><span class="p">);</span>
    <span class="n">preludephasemap</span> <span class="o">=</span> <span class="n">preludephasemap_all</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">];</span>

    <span class="n">preludemask</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">datasize1</span><span class="p">,</span><span class="n">datasize2</span><span class="p">);</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">preludephasemap</span><span class="o">.==</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">preludemask</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="o">.=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">preludephasemap_cpe</span> <span class="o">=</span> <span class="n">closest_point_estimation</span><span class="p">(</span><span class="n">preludephasemap</span><span class="p">,</span><span class="n">preludemask</span><span class="p">);</span>

    <span class="n">headerinfo5</span> <span class="o">=</span> <span class="n">load_nii_header</span><span class="p">(</span><span class="n">criticalROI_nii_file</span><span class="p">);</span>
    <span class="n">criticalROI_all</span> <span class="o">=</span> <span class="n">load_nii_data</span><span class="p">(</span><span class="n">criticalROI_nii_file</span><span class="p">,</span> <span class="n">headerinfo5</span><span class="p">);</span>
    <span class="n">criticalROI</span> <span class="o">=</span> <span class="n">criticalROI_all</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">];</span>

    <span class="n">L2</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">criticalROI</span><span class="o">.==</span><span class="n">criticalROILabel</span><span class="p">);</span>

    <span class="k">if</span> <span class="n">length</span><span class="p">(</span><span class="n">L2</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
        <span class="n">xcoordarray</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="kt">Int64</span><span class="p">,</span><span class="n">length</span><span class="p">(</span><span class="n">L2</span><span class="p">));</span>
        <span class="n">ycoordarray</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="kt">Int64</span><span class="p">,</span><span class="n">length</span><span class="p">(</span><span class="n">L2</span><span class="p">));</span>
        <span class="k">for</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">L2</span><span class="p">)</span>
            <span class="n">xcoordarray</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="n">cnt</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">ycoordarray</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">L2</span><span class="p">[</span><span class="n">cnt</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
        <span class="k">end</span>

        <span class="n">roiStartX</span> <span class="o">=</span> <span class="n">minimum</span><span class="p">(</span><span class="n">xcoordarray</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">roiEndX</span> <span class="o">=</span> <span class="n">maximum</span><span class="p">(</span><span class="n">xcoordarray</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">roiStartY</span> <span class="o">=</span> <span class="n">minimum</span><span class="p">(</span><span class="n">ycoordarray</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">roiEndY</span> <span class="o">=</span> <span class="n">maximum</span><span class="p">(</span><span class="n">ycoordarray</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">xdim</span> <span class="o">=</span> <span class="n">roiEndX</span><span class="o">-</span><span class="n">roiStartX</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">ydim</span> <span class="o">=</span> <span class="n">roiEndY</span><span class="o">-</span><span class="n">roiStartY</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

        <span class="n">boundaryConditionMap</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span><span class="n">preludephasemap_cpe</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">]);</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">xdim</span><span class="p">,</span><span class="n">ydim</span><span class="p">)</span><span class="o">-</span><span class="n">criticalROI</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">];</span>
        <span class="n">snr_ref</span> <span class="o">=</span> <span class="n">abs</span><span class="o">.</span><span class="p">(</span><span class="n">imgsn</span><span class="p">)[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">]</span><span class="o">.*</span><span class="n">mask</span><span class="p">;</span>
        <span class="n">λmap</span> <span class="o">=</span> <span class="n">snr_ref</span> <span class="o">./</span><span class="n">maximum</span><span class="p">(</span><span class="n">snr_ref</span><span class="p">[</span><span class="o">:</span><span class="p">]);</span>
        <span class="n">λmap</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.=</span><span class="mf">2.</span><span class="p">;</span>
        <span class="n">λmap</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="k">end</span><span class="p">]</span><span class="o">.=</span><span class="mf">2.</span><span class="p">;</span>
        <span class="n">λmap</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="o">.=</span><span class="mf">2.</span><span class="p">;</span>
        <span class="n">λmap</span><span class="p">[</span><span class="k">end</span><span class="p">,</span><span class="o">:</span><span class="p">]</span><span class="o">.=</span><span class="mf">2.</span><span class="p">;</span>
        <span class="n">Mgv</span> <span class="o">=</span> <span class="n">pxmap_radppixel</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">];</span>
        <span class="n">Mgh</span> <span class="o">=</span> <span class="n">pymap_radppixel</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">];</span>

        <span class="n">M_recovered</span> <span class="o">=</span> <span class="n">twoDimIntegration</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">boundaryConditionMap</span><span class="p">,</span><span class="n">λmap</span><span class="p">,</span><span class="n">Mgv</span><span class="p">,</span><span class="n">Mgh</span><span class="p">);</span>

        <span class="n">newPhaseMap</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">preludephasemap_cpe</span><span class="p">);</span>
        <span class="n">newPhaseMap</span><span class="p">[</span><span class="n">roiStartX</span><span class="o">:</span><span class="n">roiEndX</span><span class="p">,</span><span class="n">roiStartY</span><span class="o">:</span><span class="n">roiEndY</span><span class="p">]</span><span class="o">=</span> <span class="n">M_recovered</span><span class="p">;</span>
        <span class="n">newPhaseMapMask</span> <span class="o">=</span> <span class="n">newPhaseMap</span><span class="o">.*</span><span class="n">preludemask</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">newPhaseMap</span> <span class="o">=</span> <span class="n">preludephasemap</span><span class="p">;</span>
        <span class="n">newPhaseMapMask</span> <span class="o">=</span> <span class="n">newPhaseMap</span><span class="o">.*</span><span class="n">preludemask</span><span class="p">;</span>
    <span class="k">end</span>

    <span class="n">headerinfo4</span><span class="p">[</span><span class="s">&quot;datatype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kt">Int16</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
    <span class="n">output_all</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span> <span class="n">preludephasemap_all</span><span class="p">);</span>
    <span class="n">newPhaseMapMask</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float32</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span> <span class="n">newPhaseMapMask</span><span class="p">);</span>
    <span class="n">output_all</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="o">:</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">]</span> <span class="o">=</span> <span class="n">newPhaseMapMask</span><span class="p">;</span>
    <span class="n">write_nii_header</span><span class="p">(</span><span class="n">output_nii_file</span><span class="p">,</span> <span class="n">headerinfo4</span><span class="p">);</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">output_nii_file</span><span class="p">,</span><span class="s">&quot;a&quot;</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">output_all</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fid</span><span class="p">);</span>

    <span class="c">#figure(1,figsize=(10,5));imshow(reverse(permutedims(vcat(preludephasemap,newPhaseMapMask),[2,1]),dims=1),cmap=&quot;hot&quot;,interpolation=&quot;none&quot;); axis(&quot;off&quot;);</span>
    <span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span><span class="n">imshow</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">permutedims</span><span class="p">(</span><span class="n">vcat</span><span class="p">(</span><span class="n">preludephasemap_cpe</span><span class="p">,</span><span class="n">newPhaseMap</span><span class="p">),[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span><span class="n">dims</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="s">&quot;hot&quot;</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">);</span> <span class="n">axis</span><span class="p">(</span><span class="s">&quot;off&quot;</span><span class="p">);</span>

<span class="k">end</span>

<span class="n">julia_main</span><span class="p">(</span><span class="n">magnitude_nii_file</span><span class="p">,</span><span class="n">phase_nii_file</span><span class="p">,</span><span class="n">partiallyUnwrapped_nii_file</span><span class="p">,</span><span class="n">criticalROI_nii_file</span><span class="p">,</span><span class="n">ChooseThisSlice</span><span class="p">,</span><span class="n">criticalROILabel</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_png output_subarea ">
<img src="../images/03/Julia_test_5_0.png"
>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> 10.399793 seconds (1.19 M allocations: 3.459 GiB, 5.49% gc time)
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

 


    </main>
    